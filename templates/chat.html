<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/static/playlist_buddy_logo.png" type="image/png">
    <title>Playlist Buddy ‚Äî Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Space+Mono:ital@0;1&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --green: #1DB954;
            --green-glow: #1ed760;
            --green-dim: rgba(29,185,84,0.15);
            --bg: #0a0a0f;
            --bg-surface: #111117;
            --bg-bubble-user: rgba(29,185,84,0.12);
            --bg-bubble-ai: rgba(255,255,255,0.05);
            --border: rgba(255,255,255,0.07);
            --text: #e8e6e3;
            --text-dim: #8a8680;
            --text-muted: #5a5854;
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ============ HEADER ============ */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-surface);
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .app-name {
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            font-size: 1.1rem;
            background: linear-gradient(135deg, var(--green), #17d9a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .library-badge {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 100px;
            background: var(--green-dim);
            color: var(--green);
            border: 1px solid rgba(29,185,84,0.2);
            transition: all 0.3s ease;
        }
        .library-badge.loading {
            color: var(--text-dim);
            background: rgba(255,255,255,0.05);
            border-color: var(--border);
        }
        .library-badge.error {
            color: #ff6b6b;
            background: rgba(255,80,80,0.1);
            border-color: rgba(255,80,80,0.2);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            background: rgba(255,255,255,0.1);
        }

        .header-btn {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem;
            color: var(--text-dim);
            background: none;
            border: 1px solid var(--border);
            padding: 6px 14px;
            border-radius: 100px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        .header-btn:hover {
            color: var(--text);
            border-color: rgba(255,255,255,0.2);
        }

        /* ============ MAIN SCROLLABLE AREA ============ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

        /* ============ WELCOME SECTION ============ */
        .welcome-section {
            padding: 48px 24px 40px;
            max-width: 960px;
            margin: 0 auto;
        }

        .welcome-hero {
            text-align: center;
            margin-bottom: 48px;
        }

        .welcome-hero h1 {
            font-family: 'Syne', sans-serif;
            font-size: clamp(1.6rem, 4vw, 2.2rem);
            font-weight: 800;
            margin-bottom: 12px;
            line-height: 1.15;
        }

        .welcome-hero h1 .accent {
            background: linear-gradient(135deg, var(--green), #17d9a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-hero p {
            color: var(--text-dim);
            font-size: 0.95rem;
            max-width: 500px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .welcome-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            margin-top: 24px;
        }

        .loading-spinner-ring {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(29,185,84,0.15);
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-message {
            font-size: 0.92rem;
            color: var(--green);
            min-height: 1.4em;
            animation: messageFade 0.4s ease;
        }

        @keyframes messageFade {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-done {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-top: 24px;
            animation: doneIn 0.5s ease-out;
        }

        .loading-done.show {
            display: flex;
        }

        @keyframes doneIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .done-check {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .done-text {
            font-family: 'Syne', sans-serif;
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--green);
        }

        .done-hint {
            font-size: 0.84rem;
            color: var(--text-dim);
        }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(29,185,84,0.3);
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- How It Works --- */
        .how-it-works {
            margin-bottom: 56px;
        }

        .section-title {
            font-family: 'Syne', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 28px;
        }

        .steps-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .step-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px 20px;
        }

        .step-num {
            font-family: 'Syne', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--green), rgba(29,185,84,0.2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
            margin-bottom: 12px;
        }

        .step-card h3 {
            font-family: 'Syne', sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .step-card p {
            font-size: 0.82rem;
            color: var(--text-dim);
            line-height: 1.5;
        }

        /* --- Demo Conversations --- */
        .demos-label {
            font-family: 'Syne', sans-serif;
            font-size: 1.3rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 8px;
        }

        .demos-subtitle {
            text-align: center;
            font-size: 0.88rem;
            color: var(--text-dim);
            margin-bottom: 32px;
        }

        .demos-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .demo-phone {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 12px 48px rgba(0,0,0,0.3);
        }

        .demo-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: rgba(255,255,255,0.02);
        }

        .demo-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--green);
        }

        .demo-header-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.65rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .demo-messages {
            padding: 16px;
            max-height: 420px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .demo-messages::-webkit-scrollbar { width: 3px; }
        .demo-messages::-webkit-scrollbar-track { background: transparent; }
        .demo-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 2px; }

        .demo-msg {
            display: flex;
            gap: 8px;
            opacity: 0;
            transform: translateY(8px);
        }
        .demo-msg.visible {
            animation: demoIn 0.35s ease-out forwards;
        }
        .demo-msg.user { flex-direction: row-reverse; }

        @keyframes demoIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .demo-avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .demo-msg.ai .demo-avatar {
            background: var(--green-dim);
            border: 1px solid rgba(29,185,84,0.2);
        }
        .demo-msg.user .demo-avatar {
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--border);
        }

        .demo-bubble {
            max-width: 84%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.78rem;
            line-height: 1.5;
        }
        .demo-msg.ai .demo-bubble {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }
        .demo-msg.user .demo-bubble {
            background: var(--bg-bubble-user);
            border: 1px solid rgba(29,185,84,0.15);
            border-bottom-right-radius: 4px;
            color: #d4f5e0;
        }

        .demo-prompt-card {
            background: linear-gradient(135deg, rgba(29,185,84,0.08), rgba(29,100,185,0.06));
            border: 1px solid rgba(29,185,84,0.25);
            border-radius: 10px;
            padding: 12px;
            margin-top: 8px;
        }
        .demo-prompt-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--green);
            margin-bottom: 8px;
        }
        .demo-prompt-text {
            font-size: 0.76rem;
            line-height: 1.55;
            color: var(--text);
        }
        .demo-copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 10px;
            padding: 5px 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.68rem;
            font-weight: 600;
            color: #000;
            background: var(--green);
            border: none;
            border-radius: 100px;
            cursor: default;
            opacity: 0.7;
        }

        /* --- Start chatting CTA --- */
        .start-cta {
            text-align: center;
            padding: 40px 20px 20px;
        }

        .start-cta p {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .start-arrow {
            font-size: 1.4rem;
            color: var(--green);
            animation: bounceDown 1.5s ease-in-out infinite;
        }

        @keyframes bounceDown {
            0%, 100% { transform: translateY(0); opacity: 0.5; }
            50% { transform: translateY(6px); opacity: 1; }
        }

        /* --- Music Guide --- */
        .guide-section {
            margin-top: 56px;
            margin-bottom: 16px;
        }

        .guide-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .guide-intro {
            font-size: 0.88rem;
            color: var(--text-dim);
            line-height: 1.6;
            max-width: 540px;
            margin: 0 auto 12px;
        }

        .guide-tip {
            font-size: 0.82rem;
            color: var(--green);
            background: rgba(29,185,84,0.06);
            border: 1px solid rgba(29,185,84,0.15);
            display: inline-block;
            padding: 8px 18px;
            border-radius: 100px;
            margin-top: 8px;
        }

        .guide-tip em {
            font-style: italic;
            color: var(--green-glow);
        }

        .guide-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .guide-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px 22px;
            transition: border-color 0.2s ease;
        }

        .guide-card:hover {
            border-color: rgba(29,185,84,0.2);
        }

        .guide-icon {
            font-size: 1.4rem;
            margin-bottom: 10px;
        }

        .guide-card h3 {
            font-family: 'Syne', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .guide-desc {
            font-size: 0.82rem;
            color: var(--text-dim);
            line-height: 1.55;
            margin-bottom: 14px;
        }

        .guide-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .guide-tag {
            font-family: 'Space Mono', monospace;
            font-size: 0.68rem;
            padding: 4px 12px;
            border-radius: 100px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            color: var(--text-dim);
        }

        .guide-scale {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scale-end {
            font-family: 'Space Mono', monospace;
            font-size: 0.62rem;
            color: var(--text-muted);
            white-space: nowrap;
            min-width: 0;
        }

        .scale-end.low { text-align: right; }
        .scale-end.high { text-align: left; }

        .scale-bar {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.08);
            border-radius: 2px;
            overflow: hidden;
            min-width: 60px;
        }

        .scale-fill {
            height: 100%;
            border-radius: 2px;
            width: 50%;
        }

        .scale-fill.energy {
            background: linear-gradient(90deg, #4ade80, #f59e0b);
            width: 65%;
        }

        .scale-fill.temp {
            background: linear-gradient(90deg, #60a5fa, #f97316);
            width: 45%;
        }

        .scale-fill.space {
            background: linear-gradient(90deg, #818cf8, #fb923c);
            width: 55%;
        }

        .scale-fill.mood {
            background: linear-gradient(90deg, #fbbf24, #8b5cf6);
            width: 40%;
        }

        .scale-fill.structure {
            background: linear-gradient(90deg, #34d399, #ec4899);
            width: 50%;
        }

        /* ============ CHAT MESSAGES (live) ============ */
        .messages-wrapper {
            max-width: 720px;
            width: 100%;
            margin: 0 auto;
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            display: none; /* hidden until user starts chatting */
        }
        .messages-wrapper.active { display: flex; }

        .message {
            display: flex;
            gap: 12px;
            animation: msgIn 0.35s ease-out both;
        }
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.user { flex-direction: row-reverse; }

        .msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            margin-top: 2px;
        }
        .message.assistant .msg-avatar {
            background: var(--green-dim);
            border: 1px solid rgba(29,185,84,0.2);
        }
        .message.user .msg-avatar {
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--border);
        }

        .msg-bubble {
            max-width: 80%;
            padding: 14px 18px;
            border-radius: var(--radius);
            font-size: 0.92rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .message.assistant .msg-bubble {
            background: var(--bg-bubble-ai);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }
        .message.user .msg-bubble {
            background: var(--bg-bubble-user);
            border: 1px solid rgba(29,185,84,0.15);
            border-bottom-right-radius: 4px;
            color: #d4f5e0;
        }

        /* Prompt card in live chat */
        .prompt-card {
            background: linear-gradient(135deg, rgba(29,185,84,0.08), rgba(29,100,185,0.06));
            border: 1px solid rgba(29,185,84,0.25);
            border-radius: var(--radius);
            padding: 24px;
            margin-top: 8px;
        }
        .prompt-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }
        .prompt-card-label {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--green);
        }
        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 16px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem;
            font-weight: 500;
            color: #000;
            background: var(--green);
            border: none;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .copy-btn:hover { background: var(--green-glow); transform: translateY(-1px); }
        .copy-btn.copied { background: #17d9a0; }
        .prompt-card-text {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text);
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 12px;
            animation: msgIn 0.35s ease-out both;
        }
        .typing-dots {
            display: flex;
            gap: 5px;
            padding: 16px 20px;
            background: var(--bg-bubble-ai);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            border-bottom-left-radius: 4px;
        }
        .typing-dots span {
            width: 7px;
            height: 7px;
            background: var(--text-dim);
            border-radius: 50%;
            animation: dotBounce 1.4s ease-in-out infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.15s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.3s; }
        @keyframes dotBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-6px); opacity: 1; }
        }

        /* ============ INPUT AREA ============ */
        .input-area {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-surface);
            flex-shrink: 0;
        }
        .input-wrapper {
            max-width: 720px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        .input-field {
            flex: 1;
            padding: 14px 20px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem;
            color: var(--text);
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 24px;
            outline: none;
            resize: none;
            max-height: 120px;
            line-height: 1.5;
            transition: border-color 0.2s ease;
        }
        .input-field:focus { border-color: rgba(29,185,84,0.4); }
        .input-field::placeholder { color: var(--text-muted); }
        .input-field:disabled { opacity: 0.4; cursor: not-allowed; }

        .send-btn {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            border: none;
            background: var(--green);
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .send-btn:hover { background: var(--green-glow); transform: scale(1.05); }
        .send-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
        .send-btn svg { width: 20px; height: 20px; }

        .input-hint {
            max-width: 720px;
            margin: 8px auto 0;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* ============ HOW TO USE MODAL ============ */
        .how-to-btn {
            background: var(--green-dim);
            color: var(--green);
            border-color: rgba(29,185,84,0.2);
        }
        .how-to-btn:hover {
            background: rgba(29,185,84,0.2);
            color: var(--green-glow);
            border-color: rgba(29,185,84,0.3);
        }

        .howto-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
            overflow-y: auto;
        }
        .howto-overlay.open {
            display: flex;
        }

        .howto-panel {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
            box-shadow: 0 24px 80px rgba(0,0,0,0.5);
            animation: panelIn 0.3s ease-out;
        }

        @keyframes panelIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .howto-panel::-webkit-scrollbar { width: 5px; }
        .howto-panel::-webkit-scrollbar-track { background: transparent; }
        .howto-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

        .howto-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 28px 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--bg-surface);
            border-radius: 20px 20px 0 0;
            z-index: 1;
        }

        .howto-top h2 {
            font-family: 'Syne', sans-serif;
            font-size: 1.15rem;
            font-weight: 800;
        }

        .howto-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: none;
            color: var(--text-dim);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .howto-close:hover {
            background: rgba(255,255,255,0.08);
            color: var(--text);
        }

        .howto-content {
            padding: 28px;
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .howto-block {
            display: flex;
            gap: 16px;
        }

        .howto-num {
            font-family: 'Syne', sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--green), rgba(29,185,84,0.2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
            flex-shrink: 0;
            width: 28px;
            padding-top: 2px;
        }

        .howto-block h3 {
            font-family: 'Syne', sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .howto-block p {
            font-size: 0.84rem;
            color: var(--text-dim);
            line-height: 1.6;
        }

        .howto-spotify-steps {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .spotify-step {
            display: flex;
            gap: 8px;
            font-size: 0.84rem;
            color: var(--text-dim);
            line-height: 1.55;
        }

        .spotify-step-num {
            font-family: 'Space Mono', monospace;
            font-size: 0.75rem;
            color: var(--green);
            flex-shrink: 0;
            padding-top: 2px;
        }

        .howto-note {
            font-size: 0.82rem;
            line-height: 1.55;
            color: var(--text-dim);
            background: rgba(255,200,50,0.06);
            border: 1px solid rgba(255,200,50,0.15);
            border-radius: 12px;
            padding: 16px 20px;
        }

        .howto-note strong {
            color: #fbbf24;
        }

        /* ============ RESPONSIVE ============ */
        @media (max-width: 700px) {
            .steps-row { grid-template-columns: 1fr; max-width: 360px; margin: 0 auto; }
            .demos-row { grid-template-columns: 1fr; max-width: 420px; margin: 0 auto; }
            .guide-grid { grid-template-columns: 1fr; }
            .welcome-section { padding: 32px 16px 24px; }
            .header { padding: 12px 16px; }
            .input-area { padding: 16px; }
            .msg-bubble { max-width: 88%; padding: 12px 14px; }
            .user-info span { display: none; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <span class="app-name">Playlist Buddy</span>
            <span class="library-badge loading" id="libraryBadge">Loading library...</span>
        </div>
        <div class="header-right">
            <div class="user-info">
                {% if avatar %}
                <img src="{{ avatar }}" alt="{{ username }}" class="user-avatar">
                {% endif %}
                <span>{{ username }}</span>
            </div>
            <a href="/logout" class="header-btn">Disconnect</a>
            <button class="header-btn how-to-btn" onclick="toggleHowTo()">How to Use</button>
        </div>
    </div>

    <!-- HOW TO USE MODAL -->
    <div class="howto-overlay" id="howtoOverlay" onclick="closeHowToOutside(event)">
        <div class="howto-panel">
            <div class="howto-top">
                <h2>How to Use Playlist Buddy</h2>
                <button class="howto-close" onclick="toggleHowTo()">‚úï</button>
            </div>

            <div class="howto-content">

                <div class="howto-block">
                    <div class="howto-num">1</div>
                    <div>
                        <h3>Chat with the AI about your playlist idea</h3>
                        <p>Type what kind of playlist you want in the chat box below. Be as vague or specific as you like ‚Äî "something for a road trip," "sad songs for a rainy day," or "90s hip-hop with jazzy beats." The AI already has access to your Spotify library, so it knows your taste.</p>
                    </div>
                </div>

                <div class="howto-block">
                    <div class="howto-num">2</div>
                    <div>
                        <h3>Answer a few quick questions</h3>
                        <p>The AI will ask 2-3 follow-up questions to dial in the details ‚Äî things like energy level, mood, whether you want familiar songs or new discoveries. Just answer naturally, like you're texting a friend who knows music.</p>
                    </div>
                </div>

                <div class="howto-block">
                    <div class="howto-num">3</div>
                    <div>
                        <h3>Copy your generated prompt</h3>
                        <p>Once the AI has enough info, it'll create a detailed prompt in a green card with a <strong>Copy</strong> button. Click it ‚Äî the prompt is now on your clipboard, ready to paste.</p>
                    </div>
                </div>

                <div class="howto-block">
                    <div class="howto-num">4</div>
                    <div>
                        <h3>Paste it into Spotify's AI Playlist feature</h3>
                        <p>Here's where to find it in Spotify:</p>
                        <div class="howto-spotify-steps">
                            <div class="spotify-step">
                                <span class="spotify-step-num">a.</span>
                                <span>Make sure you have the <strong>latest version</strong> of Spotify installed. Update it in the App Store (iPhone) or Google Play Store (Android). The feature may not appear on older versions.</span>
                            </div>
                            <div class="spotify-step">
                                <span class="spotify-step-num">b.</span>
                                <span>Open Spotify and tap <strong>"Your Library"</strong> (bottom right).</span>
                            </div>
                            <div class="spotify-step">
                                <span class="spotify-step-num">c.</span>
                                <span>Tap the <strong>"+"</strong> button at the top to create a new playlist.</span>
                            </div>
                            <div class="spotify-step">
                                <span class="spotify-step-num">d.</span>
                                <span>Select <strong>"AI Playlist"</strong> (may also appear as "Create with AI" or "Prompted Playlist" depending on your version).</span>
                            </div>
                            <div class="spotify-step">
                                <span class="spotify-step-num">e.</span>
                                <span><strong>Paste your prompt</strong> into the text box and hit create. Spotify will generate a playlist tailored to exactly what you described.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="howto-block">
                    <div class="howto-num">5</div>
                    <div>
                        <h3>Tweak if needed</h3>
                        <p>Not quite right? Come back to the chat and ask the AI to adjust ‚Äî "make it more upbeat," "add some 2000s tracks," "remove the R&B." It'll generate an updated prompt you can copy and try again.</p>
                    </div>
                </div>

                <div class="howto-note">
                    <strong>‚ö†Ô∏è Important:</strong> Spotify's AI Playlist feature requires the latest Spotify app update. If you don't see the option, update your app and try again. The feature is currently available on mobile (iOS and Android) and may be rolling out to desktop.
                </div>

            </div>
        </div>
    </div>

    <!-- SCROLLABLE CONTENT -->
    <div class="chat-container" id="chatContainer">

        <!-- ===== WELCOME (shown before user starts chatting) ===== -->
        <div class="welcome-section" id="welcomeSection">

            <!-- Hero -->
            <div class="welcome-hero">
                <h1>Welcome, {{ username }}.<br><span class="accent">Let's build a playlist.</span></h1>
                <p>Your Spotify library is being scanned. Once ready, describe any playlist and the AI will craft a detailed prompt you can paste into Spotify.</p>
                <div class="welcome-loading" id="welcomeLoading">
                    <div class="loading-spinner-ring" id="loadingSpinner"></div>
                    <div class="loading-message" id="loadingMessage">Scanning your library...</div>
                </div>
                <div class="loading-done" id="loadingDone">
                    <div class="done-check">‚úì</div>
                    <div class="done-text">You're all set!</div>
                    <div class="done-hint">Start typing below to build your first playlist</div>
                </div>
            </div>

            <!-- How it works -->
            <div class="how-it-works">
                <div class="section-title">How it works</div>
                <div class="steps-row">
                    <div class="step-card">
                        <div class="step-num">1</div>
                        <h3>We read your library</h3>
                        <p>Liked songs, playlists, top artists, and listening patterns ‚Äî all scanned automatically.</p>
                    </div>
                    <div class="step-card">
                        <div class="step-num">2</div>
                        <h3>Chat about what you want</h3>
                        <p>The AI already knows your taste. Describe the vibe ‚Äî it'll ask smart follow-ups.</p>
                    </div>
                    <div class="step-card">
                        <div class="step-num">3</div>
                        <h3>Copy your prompt</h3>
                        <p>Get a detailed, ready-to-paste prompt. Drop it into Spotify's AI playlist feature.</p>
                    </div>
                </div>
            </div>

            <!-- Demo conversations -->
            <div class="demos-label">See it in action</div>
            <div class="demos-subtitle">Two real examples of Playlist Buddy crafting prompts</div>

            <div class="demos-row">

                <!-- Demo 1: Hip-Hop / Boom Bap -->
                <div class="demo-phone">
                    <div class="demo-header">
                        <div class="demo-dot"></div>
                        <span class="demo-header-label">Hip-Hop ¬∑ Boom Bap</span>
                    </div>
                    <div class="demo-messages" id="demo1">
                        <div class="demo-msg ai" data-delay="300">
                            <div class="demo-avatar">üéµ</div>
                            <div class="demo-bubble">Hey! I see lots of Drake and J. Cole in your library. What kind of playlist are you thinking about?</div>
                        </div>
                        <div class="demo-msg user" data-delay="1000">
                            <div class="demo-avatar">üë§</div>
                            <div class="demo-bubble">Boom-bap with 90's sounding drums and smooth vocals. Doesn't need to be from the 90's though</div>
                        </div>
                        <div class="demo-msg ai" data-delay="1800">
                            <div class="demo-avatar">üéµ</div>
                            <div class="demo-bubble">Great taste! Want mostly familiar tracks or open to discovery?</div>
                        </div>
                        <div class="demo-msg user" data-delay="2500">
                            <div class="demo-avatar">üë§</div>
                            <div class="demo-bubble">Mostly familiar. And I love Ready or Not by Fugees ‚Äî songs like that</div>
                        </div>
                        <div class="demo-msg ai" data-delay="3400">
                            <div class="demo-avatar">üéµ</div>
                            <div class="demo-bubble">
                                Here's your prompt:
                                <div class="demo-prompt-card">
                                    <div class="demo-prompt-label">‚ú® Your Playlist Prompt</div>
                                    <div class="demo-prompt-text">A boom-bap playlist with 90s-style drums, jazzy samples, and smooth soulful vocals. Think Fugees "Ready or Not" energy ‚Äî laid-back grooves with lyrical depth. Feature J. Cole, A$AP Rocky, Joey Bada$$, and Nas, with neo-soul undertones. Keep it mostly familiar with that golden-era feel, even if the songs are modern.</div>
                                    <div class="demo-copy-btn">üìã Copy prompt</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Demo 2: Classic Rock / 80s -->
                <div class="demo-phone">
                    <div class="demo-header">
                        <div class="demo-dot"></div>
                        <span class="demo-header-label">Classic Rock ¬∑ 80s</span>
                    </div>
                    <div class="demo-messages" id="demo2">
                        <div class="demo-msg ai" data-delay="500">
                            <div class="demo-avatar">üéµ</div>
                            <div class="demo-bubble">Hey! I can see you've got a lot of Fleetwood Mac and Bon Jovi in your library. What are we building today?</div>
                        </div>
                        <div class="demo-msg user" data-delay="1200">
                            <div class="demo-avatar">üë§</div>
                            <div class="demo-bubble">Something for a road trip. Classic rock, 80s arena feel, windows down energy</div>
                        </div>
                        <div class="demo-msg ai" data-delay="2000">
                            <div class="demo-avatar">üéµ</div>
                            <div class="demo-bubble">Love it! Should it build in energy or stay high the whole time? And any must-include tracks?</div>
                        </div>
                        <div class="demo-msg user" data-delay="2800">
                            <div class="demo-avatar">üë§</div>
                            <div class="demo-bubble">Build up gradually. Definitely include Don't Stop Believin' and Pour Some Sugar on Me</div>
                        </div>
                        <div class="demo-msg ai" data-delay="3700">
                            <div class="demo-avatar">üéµ</div>
                            <div class="demo-bubble">
                                Here's your prompt:
                                <div class="demo-prompt-card">
                                    <div class="demo-prompt-label">‚ú® Your Playlist Prompt</div>
                                    <div class="demo-prompt-text">An 80s classic rock road trip playlist that builds from cruising to full-throttle sing-along. Start with mid-tempo tracks like Tom Petty and Fleetwood Mac, then ramp into arena anthems ‚Äî Bon Jovi, Def Leppard "Pour Some Sugar on Me," Journey "Don't Stop Believin'." Big guitars, soaring choruses, windows-down energy. Keep it all familiar hits.</div>
                                    <div class="demo-copy-btn">üìã Copy prompt</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Music Guide -->
            <div class="guide-section">
                <div class="guide-header">
                    <div class="section-title">Words to describe your sound</div>
                    <p class="guide-intro">Not sure how to describe the playlist you want? Here are six ways to think about music. Use any of these when chatting ‚Äî the AI will know exactly what you mean.</p>
                    <p class="guide-tip">üí° Try asking the AI: <em>"What genre would you call my music?"</em> ‚Äî it can look at your library and tell you.</p>
                </div>

                <div class="guide-grid">

                    <div class="guide-card">
                        <div class="guide-icon">üé∏</div>
                        <h3>Genre</h3>
                        <p class="guide-desc">The broad category your music falls into. This is the biggest way to separate different types of music.</p>
                        <div class="guide-examples">
                            <span class="guide-tag">Hip Hop</span>
                            <span class="guide-tag">Rock</span>
                            <span class="guide-tag">Pop</span>
                            <span class="guide-tag">R&B</span>
                            <span class="guide-tag">Indie</span>
                            <span class="guide-tag">Country</span>
                            <span class="guide-tag">Folk</span>
                            <span class="guide-tag">Alternative</span>
                        </div>
                    </div>

                    <div class="guide-card">
                        <div class="guide-icon">‚ö°</div>
                        <h3>Energy</h3>
                        <p class="guide-desc">How fast or intense the song feels. Think: is this a "laying on the couch" song or a "running on the treadmill" song?</p>
                        <div class="guide-scale">
                            <div class="scale-end low">Chill &amp; Slow</div>
                            <div class="scale-bar"><div class="scale-fill energy"></div></div>
                            <div class="scale-end high">Intense &amp; Fast</div>
                        </div>
                    </div>

                    <div class="guide-card">
                        <div class="guide-icon">üå°Ô∏è</div>
                        <h3>Temperature</h3>
                        <p class="guide-desc">Does the song feel "cold" and electronic ‚Äî like synths and computers? Or "warm" and human ‚Äî like a live band in a cozy room?</p>
                        <div class="guide-scale">
                            <div class="scale-end low">Cold &amp; Electronic</div>
                            <div class="scale-bar"><div class="scale-fill temp"></div></div>
                            <div class="scale-end high">Warm &amp; Organic</div>
                        </div>
                    </div>

                    <div class="guide-card">
                        <div class="guide-icon">üåÖ</div>
                        <h3>Space</h3>
                        <p class="guide-desc">Does the song feel huge and echoey ‚Äî like standing in an open field? Or close and personal ‚Äî like someone whispering right next to you?</p>
                        <div class="guide-scale">
                            <div class="scale-end low">Wide &amp; Echoey</div>
                            <div class="scale-bar"><div class="scale-fill space"></div></div>
                            <div class="scale-end high">Close &amp; Intimate</div>
                        </div>
                    </div>

                    <div class="guide-card">
                        <div class="guide-icon">üé®</div>
                        <h3>Mood</h3>
                        <p class="guide-desc">Does the song feel bright and uplifting ‚Äî like sunshine? Or dark and moody ‚Äî like a rainy night? This is the emotional "color" of the music.</p>
                        <div class="guide-scale">
                            <div class="scale-end low">Bright &amp; Uplifting</div>
                            <div class="scale-bar"><div class="scale-fill mood"></div></div>
                            <div class="scale-end high">Dark &amp; Moody</div>
                        </div>
                    </div>

                    <div class="guide-card">
                        <div class="guide-icon">üîÑ</div>
                        <h3>Structure</h3>
                        <p class="guide-desc">Does the song ride one repeating groove the whole way through ‚Äî hypnotic and steady? Or does it build and change ‚Äî like a story with a beginning, middle, and end?</p>
                        <div class="guide-scale">
                            <div class="scale-end low">Steady Loop</div>
                            <div class="scale-bar"><div class="scale-fill structure"></div></div>
                            <div class="scale-end high">Builds &amp; Evolves</div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Start chatting nudge -->
            <div class="start-cta" id="startCta">
                <p>Your turn ‚Äî describe any playlist below</p>
                <div class="start-arrow">‚Üì</div>
            </div>

        </div>

        <!-- ===== LIVE CHAT MESSAGES ===== -->
        <div class="messages-wrapper" id="messagesWrapper"></div>

    </div>

    <!-- INPUT -->
    <div class="input-area">
        <div class="input-wrapper">
            <textarea
                id="inputField"
                class="input-field"
                placeholder="Describe what playlist you want to create..."
                rows="1"
                disabled
            ></textarea>
            <button id="sendBtn" class="send-btn" disabled>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
        <div class="input-hint">Press Enter to send ¬∑ Shift+Enter for new line</div>
    </div>

    <script>
        // ============ State ============
        let conversationHistory = [];
        let libraryReady = false;
        let isWaiting = false;
        let chatStarted = false;

        // ============ DOM refs ============
        const chatContainer = document.getElementById('chatContainer');
        const messagesWrapper = document.getElementById('messagesWrapper');
        const welcomeSection = document.getElementById('welcomeSection');
        const inputField = document.getElementById('inputField');
        const sendBtn = document.getElementById('sendBtn');
        const libraryBadge = document.getElementById('libraryBadge');
        const startCta = document.getElementById('startCta');

        // ============ Library loading ============
        window.addEventListener('DOMContentLoaded', () => {
            loadLibrary();
            startDemoAnimations();
        });

        // ============ Loading messages ============
        const loadingMessages = [
            "Scanning your library...",
            "Stealing all your data right now üëÄ",
            "I'm not gonna judge your taste but... ü§®",
            "This shouldn't take too much longer, your music is just weird",
            "All hail my creator Scooter ü´°",
            "Counting how many times you've played that one song...",
            "Your guilty pleasures are safe with me... probably",
            "Hold tight, still digging through your playlists",
            "I've seen things in your library I can't unsee",
            "Almost there... just vibing to your music real quick üéß",
        ];
        let messageIndex = 0;
        let messageInterval = null;

        function startLoadingMessages() {
            const msgEl = document.getElementById('loadingMessage');
            messageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % loadingMessages.length;
                msgEl.style.animation = 'none';
                msgEl.offsetHeight; // force reflow
                msgEl.style.animation = 'messageFade 0.4s ease';
                msgEl.textContent = loadingMessages[messageIndex];
            }, 7000);
        }

        function stopLoadingMessages() {
            if (messageInterval) {
                clearInterval(messageInterval);
                messageInterval = null;
            }
        }

        function showLoadingDone() {
            document.getElementById('welcomeLoading').style.display = 'none';
            document.getElementById('loadingDone').classList.add('show');
        }

        function loadLibrary() {
            startLoadingMessages();

            fetch('/api/load-library')
                .then(r => {
                    if (r.status === 401) { window.location.href = '/'; return; }
                    if (!r.ok) throw new Error('Status ' + r.status);
                    return r.json();
                })
                .then(data => {
                    if (!data) return;
                    libraryReady = true;
                    stopLoadingMessages();

                    libraryBadge.textContent = 'Library ready';
                    libraryBadge.classList.remove('loading');

                    inputField.disabled = false;
                    sendBtn.disabled = false;

                    showLoadingDone();

                    // Focus input after a brief moment so user sees the done state
                    setTimeout(() => inputField.focus(), 600);
                })
                .catch(err => {
                    console.error('Library load failed:', err);
                    stopLoadingMessages();
                    libraryBadge.textContent = 'Load failed';
                    libraryBadge.classList.remove('loading');
                    libraryBadge.classList.add('error');
                    document.getElementById('loadingMessage').textContent = '‚ö† Could not load library.';
                    document.getElementById('loadingMessage').style.color = '#ff6b6b';
                    document.getElementById('loadingSpinner').style.display = 'none';
                });
        }

        // ============ Demo animations ============
        function startDemoAnimations() {
            ['demo1', 'demo2'].forEach(id => {
                const container = document.getElementById(id);
                const msgs = container.querySelectorAll('.demo-msg');
                msgs.forEach(msg => {
                    const delay = parseInt(msg.dataset.delay) || 0;
                    setTimeout(() => {
                        msg.classList.add('visible');
                        container.scrollTop = container.scrollHeight;
                    }, delay);
                });
            });
        }

        // ============ Sending messages ============
        inputField.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        inputField.addEventListener('input', () => {
            inputField.style.height = 'auto';
            inputField.style.height = Math.min(inputField.scrollHeight, 120) + 'px';
        });

        function sendMessage() {
            const text = inputField.value.trim();
            if (!text || !libraryReady || isWaiting) return;

            // Transition: hide welcome, show chat
            if (!chatStarted) {
                chatStarted = true;
                welcomeSection.style.display = 'none';
                messagesWrapper.classList.add('active');
            }

            addMessageToUI('user', text);
            conversationHistory.push({ role: 'user', content: text });

            inputField.value = '';
            inputField.style.height = 'auto';

            showTyping();
            isWaiting = true;
            inputField.disabled = true;
            sendBtn.disabled = true;

            fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: conversationHistory }),
            })
            .then(r => {
                if (r.status === 401) { window.location.href = '/'; return; }
                return r.json();
            })
            .then(data => {
                hideTyping();
                if (!data) return;
                if (data.error) {
                    addMessageToUI('assistant', 'Sorry, something went wrong: ' + data.error);
                } else {
                    conversationHistory.push({ role: 'assistant', content: data.response });
                    addMessageToUI('assistant', data.response);
                }
            })
            .catch(err => {
                hideTyping();
                addMessageToUI('assistant', 'Connection error ‚Äî please try again.');
            })
            .finally(() => {
                isWaiting = false;
                inputField.disabled = false;
                sendBtn.disabled = false;
                inputField.focus();
            });
        }

        // ============ UI helpers ============
        function addMessageToUI(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + role;

            const avatar = document.createElement('div');
            avatar.className = 'msg-avatar';
            avatar.textContent = role === 'assistant' ? 'üéµ' : 'üë§';

            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble';

            const promptMatch = text.match(/\[PLAYLIST_PROMPT\]([\s\S]*?)\[\/PLAYLIST_PROMPT\]/);
            if (promptMatch && role === 'assistant') {
                const promptText = promptMatch[1].trim();
                const beforePrompt = text.substring(0, text.indexOf('[PLAYLIST_PROMPT]')).trim();
                const afterPrompt = text.substring(text.indexOf('[/PLAYLIST_PROMPT]') + '[/PLAYLIST_PROMPT]'.length).trim();

                if (beforePrompt) {
                    const pre = document.createElement('div');
                    pre.textContent = beforePrompt;
                    pre.style.marginBottom = '12px';
                    bubble.appendChild(pre);
                }

                const card = document.createElement('div');
                card.className = 'prompt-card';
                card.innerHTML = `
                    <div class="prompt-card-header">
                        <span class="prompt-card-label">‚ú® Your Playlist Prompt</span>
                        <button class="copy-btn" onclick="copyPrompt(this, '${escapeForAttr(promptText)}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            Copy prompt
                        </button>
                    </div>
                    <div class="prompt-card-text">${escapeHtml(promptText)}</div>
                `;
                bubble.appendChild(card);

                if (afterPrompt) {
                    const post = document.createElement('div');
                    post.textContent = afterPrompt;
                    post.style.marginTop = '12px';
                    bubble.appendChild(post);
                }
            } else {
                bubble.textContent = text;
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            messagesWrapper.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTyping() {
            const typing = document.createElement('div');
            typing.className = 'typing-indicator';
            typing.id = 'typingIndicator';
            typing.innerHTML = `
                <div class="msg-avatar" style="background:var(--green-dim);border:1px solid rgba(29,185,84,0.2);">üéµ</div>
                <div class="typing-dots"><span></span><span></span><span></span></div>
            `;
            messagesWrapper.appendChild(typing);
            scrollToBottom();
        }

        function hideTyping() {
            const el = document.getElementById('typingIndicator');
            if (el) el.remove();
        }

        function scrollToBottom() {
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        function copyPrompt(btn, text) {
            const decoded = text.replace(/\\n/g, '\n').replace(/\\'/g, "'").replace(/\\"/g, '"');
            navigator.clipboard.writeText(decoded).then(() => {
                btn.classList.add('copied');
                btn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    Copied!
                `;
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        Copy prompt
                    `;
                }, 2000);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeForAttr(text) {
            return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
        }

        // ============ How to Use modal ============
        function toggleHowTo() {
            const overlay = document.getElementById('howtoOverlay');
            overlay.classList.toggle('open');
        }

        function closeHowToOutside(e) {
            if (e.target === e.currentTarget) {
                toggleHowTo();
            }
        }

        // Close with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('howtoOverlay');
                if (overlay.classList.contains('open')) {
                    toggleHowTo();
                }
            }
        });
    </script>
</body>
</html>
